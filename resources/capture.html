<!DOCTYPE html>
<html>
<head>
	<title>Photo Booth Capture Page</title>
	<meta name='viewport' content='width=device-width, initial-scale=1.0' />
	<!-- <script src='./app.js'></script> -->
    <!-- <link rel='stylesheet' type='text/css' href='./style.css'> -->
	<style type='text/css'>
		body {
			background-color: black;
		}
		video {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0;
			right: 0;
		}

		canvas {
			display: none;
		}

		button {
			border-radius: 50%;
			height:  50px;
			width:  50px;
			background-color:  red;
			position: absolute;
			bottom: 10%;
			right:  50%;
			transform: translate(50%,50%);
			border: none;
		    outline: 0;
		 	text-transform: uppercase;
		    box-shadow: none;
		}
	   
	</style>
</head>
<body>
	<video id='video' width='1280' height='720' autoplay>
		Your browser does not support the video tag.
	</video>
	<button id='snap'>Snap</button>
	<canvas id='canvas' width='320' height='240'></canvas>	
</body>

<script>
var context; // Lazy/dumb hoisting

//Standarized the getUserMedia function across all of the different browsers
navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

/** check if url is https or localhost and alert the user that we will not be able to access the microphone */
var audioCaptureInitializationCheck = function () {
	var url = window.location.href;
	var secureUrlIdentifier = 'https';
	var localhostIdentifier = 'localhost';

	if (url.indexOf(secureUrlIdentifier) === -1) {
		if (url.indexOf(localhostIdentifier) === -1){
			alert('Either need https or localhost to capture from the camera and microphone')
		}
		else {
			return true;
		}
	}
	else {
		return true;
	}
}

	// Put event listeners into place
window.addEventListener('DOMContentLoaded', function() {
	// Grab elements, create settings, etc.
	var canvas = document.getElementById('canvas'),
		video = document.getElementById('video'),
		videoObj = { 'video': true },
		errBack = function(error) {
			console.log('Video capture error: ', error.code); 
		};
		context = canvas.getContext('2d');


	navigator.getUserMedia(videoObj, function(stream) {
		video.src = window.URL.createObjectURL(stream); // || stream // who even uses stream, IE? lol; 
		video.play();
	}, errBack);

	// // Trigger to take pic needs to get added after DOM is good
	document.getElementById('snap').addEventListener('click', function() {
		// need to do some binding or something I am too tired to deal with right now
		context.drawImage(video, 0, 0, 320, 240);
		uploadImage();
		// initiateCountdown();
	});

}, false);


function uploadImage() {
    var xhr = new XMLHttpRequest();

    xhr.open('POST','/uploadImage',true);    
    var base64ImageValue = canvas.toDataURL('image/png')
 
    if(base64ImageValue && navigator.getUserMedia) {
		var formdata = new FormData();
		formdata.append('pic',base64ImageValue);
		xhr.send(formdata);
	}
}

var initiateCountdown = function () {
	// Starts countdown on the screen: 3...2...1...Flash/Snap Animation
};

var disableState = function () {
	// place a div over the button to render it unclickable
};

//TODO: Countdown overlay timer delay
//TODO: Add scrim to button and disable state

//TODO: Filter overlays
//TODO: Swipe to change overlays

//TODO: Create toggle for modes (camera and display)
//TODO: Create share to allow for multiple camera inputs to the same event

</script>
</html>